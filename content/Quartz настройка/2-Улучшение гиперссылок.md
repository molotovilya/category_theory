---
title: 2. Улучшение гипер-ссылок
---

## Обзор изменений

Реализованы четыре ключевых улучшения для работы со ссылками в Quartz:

1. Разные цвета для 
	- Внешних 
	- Внутренних 
	- Несуществующих ссылок
	- плюс убрал серые рамки вокруг ссылок
2. Скрипт определения несуществующих 404 страниц 
3. Защита от перехода на 404 страницы
	 - блокировка кликов
	 - блокировка превью 
4. **Popover** (предпросмотр) по требованию -  окно предпросмотра появляется только при зажатом Ctrl + наведении мыши

---

## 1. Различные цвета

### Файл: `quartz/styles/custom.scss`

```scss
// Убираем серую рамочку со всех внутренних ссылок
a.internal {
  background-color: transparent !important;
  padding: 0 !important;
}

// Внешние ссылки - зелёный цвет
a.external {
  color: #549a63 !important;
  
  &:hover {
    color: #78be87 !important;
  }
}

// Внутренние существующие - дефолтный цвет темы
a.internal:not(.broken) {
  color: var(--secondary);
  
  &:hover {
    color: var(--tertiary);
  }
}

// Несуществующие ссылки - серый цвет
// ВАЖНО: Требует скрипт brokenLinks.inline.ts
a.internal.broken {
  color: #8a8a8a !important;
  opacity: 1 !important;
  
  &:hover {
    color: #928080 !important;
  }
}
```

**Результат:**

- Внешние ссылки: зелёный (#549a63)
- Внутренние существующие: цвета темы (var(--secondary))
- Несуществующие: серый (#8a8a8a)
- Убрана фоновая серая рамочка

---

## 2. Отслеживание несуществующих ссылок

### Файл: `quartz/components/scripts/brokenLinks.inline.ts` (новый)

```typescript
document.addEventListener("nav", async () => {
  try {
    const data = await fetchData
    const contentIndex = Array.isArray(data) ? data : Object.values(data)
    const allSlugs = new Set(contentIndex.map((item: any) => item.slug))
    
    const internalLinks = document.querySelectorAll("a.internal[data-slug]")
    
    internalLinks.forEach((link) => {
      const slug = link.getAttribute("data-slug")
      if (!slug) return
      
      if (!allSlugs.has(slug)) {
        link.classList.add("broken")
        link.setAttribute("data-no-popover", "true")
        
        const blockClick = (e: Event) => {
          e.preventDefault()
          e.stopPropagation()
          return false
        }
        
        link.addEventListener("click", blockClick, true)
        window.addCleanup(() => link.removeEventListener("click", blockClick, true))
      }
    })
  } catch (error) {
    console.error("Ошибка в BrokenLinks:", error)
  }
})
```

**Логика работы:**

1. При каждой навигации загружается индекс всех страниц (`fetchData`)
2. Создаётся Set со всеми существующими slug'ами
3. Для каждой внутренней ссылки проверяется наличие её slug в индексе
4. Если slug отсутствует:
    - Добавляется класс `.broken` (для CSS стилизации)
    - Устанавливается `data-no-popover="true"` (отключает превью)
    - Добавляется обработчик блокировки клика

---

## 3. Подключение скрипта broken links

### Файл: `quartz/components/Body.tsx`

```typescript
// @ts-ignore
import clipboardScript from "./scripts/clipboard.inline"
// @ts-ignore
import brokenLinksScript from "./scripts/brokenLinks.inline"
import clipboardStyle from "./styles/clipboard.scss"
import { QuartzComponent, QuartzComponentConstructor, QuartzComponentProps } from "./types"

const Body: QuartzComponent = ({ children }: QuartzComponentProps) => {
  return <div id="quartz-body">{children}</div>
}

Body.afterDOMLoaded = clipboardScript + "\n" + brokenLinksScript
Body.css = clipboardStyle

export default (() => Body) satisfies QuartzComponentConstructor
```

**Изменения:**

- Добавлен импорт `brokenLinksScript`
- Скрипт добавлен в `Body.afterDOMLoaded` для выполнения после загрузки DOM
- Скрипт выполняется на каждой странице при навигации

---

## 4. Popover (предпросмотр страниц) только при Ctrl

### Файл: `quartz/components/scripts/popover.inline.ts`

**Изменена функция `mouseEnterHandler`:**

```typescript
async function mouseEnterHandler(
  this: HTMLAnchorElement,
  e: MouseEvent,  // Изменено: вместо { clientX, clientY }
) {
  // НОВОЕ: Проверяем зажат ли Ctrl (или Cmd на Mac)
  if (!e.ctrlKey && !e.metaKey) {
    return
  }

  const { clientX, clientY } = e  // НОВОЕ: извлекаем координаты
  const link = (activeAnchor = this)
  if (link.dataset.noPopover === "true") {
    return
  }

  // ... остальной код без изменений
}
```

**Изменения:**

- Параметр функции изменён с деструктурированных координат на полный объект `MouseEvent`
- Добавлена проверка `e.ctrlKey` (Ctrl на Windows/Linux) и `e.metaKey` (Cmd на Mac)
- Если модификатор не зажат - функция завершается без показа popover
- Координаты извлекаются внутри функции после проверки

**Результат:**

- Без Ctrl: просто ховер, ничего не происходит
- Ctrl + ховер: появляется окно предпросмотра
- Для broken links: popover не появляется даже с Ctrl (благодаря `data-no-popover="true"`)

---

## Итоговый результат

### ✅ Что работает

|Тип ссылки|Цвет|Клик|Превью (без Ctrl)|Превью (с Ctrl)|
|---|---|---|---|---|
|Внешняя|Зелёный|Работает|Нет|Нет|
|Внутренняя существующая|Дефолтный|Работает|Нет|**Да**|
|Внутренняя несуществующая|Серый|**Заблокирован**|Нет|Нет|

### Преимущества

1. **Визуальная ясность** - сразу видно какие ссылки ведут куда
2. **Защита от ошибок** - невозможно перейти на несуществующую страницу
3. **Производительность** - popover не загружается при каждом наведении
4. **Удобство** - Ctrl+hover для быстрого просмотра содержимого

---

## Настройка цветов

Если нужно изменить цвета, отредактируйте `quartz/styles/custom.scss`:

```scss
// Внешние ссылки (сейчас: зелёный)
a.external {
  color: #549a63 !important;      // основной цвет
  &:hover {
    color: #78be87 !important;    // цвет при наведении
  }
}

// Несуществующие ссылки (сейчас: серый)
a.internal.broken {
  color: #8a8a8a !important;      // основной цвет
  &:hover {
    color: #928080 !important;    // цвет при наведении
  }
}
```

---
## Структура файлов

```
quartz/
├── components/
│   ├── Body.tsx                          (изменён)
│   └── scripts/
│       ├── brokenLinks.inline.ts         (новый)
│       └── popover.inline.ts             (изменён)
└── styles/
    └── custom.scss                       (изменён)
```

---
**Версия Quartz:** 4